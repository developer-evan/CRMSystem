@page "/customers"
@rendermode InteractiveServer
@using crm_app.Services
@inject ICustomerService CustomerService
@inject IJSRuntime JSRuntime

<PageTitle>Customer Management</PageTitle>

<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1 class="display-4">Customer Relationship Management</h1>
            <p class="lead">Manage your customer accounts</p>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(alertMessage))
    {
        <div class="alert @(alertSuccess ? "alert-success" : "alert-danger") alert-dismissible fade show" role="alert">
            @alertMessage
            <button type="button" class="btn-close" @onclick="() => alertMessage = null"></button>
        </div>
    }

    <div class="row mb-3">
        <div class="col">
            <button class="btn btn-primary btn-lg" @onclick="ShowAddForm">
                <i class="bi bi-plus-circle"></i> Add New Customer
            </button>
        </div>
    </div>

    <!-- Add/Edit Customer Modal -->
    @if (showForm)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">@(editingCustomer?.AccountId > 0 ? "Edit Customer" : "Add New Customer")</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelEdit" disabled="@isProcessing"></button>
                    </div>
                    <div class="modal-body">
                        @if (!string.IsNullOrEmpty(modalErrorMessage))
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle-fill me-2"></i>@modalErrorMessage
                                <button type="button" class="btn-close" @onclick="() => modalErrorMessage = null"></button>
                            </div>
                        }
                        
                        <EditForm Model="editingCustomer" OnValidSubmit="HandleValidSubmit">
                            <DataAnnotationsValidator />
                            <ValidationSummary class="text-danger" />

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="firstName" class="form-label">First Name *</label>
                                    <InputText id="firstName" class="form-control" @bind-Value="editingCustomer!.FirstName" />
                                    <ValidationMessage For="@(() => editingCustomer!.FirstName)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="lastName" class="form-label">Last Name *</label>
                                    <InputText id="lastName" class="form-control" @bind-Value="editingCustomer!.LastName" />
                                    <ValidationMessage For="@(() => editingCustomer!.LastName)" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email *</label>
                                    <InputText id="email" type="email" class="form-control" @bind-Value="editingCustomer!.Email" />
                                    <ValidationMessage For="@(() => editingCustomer!.Email)" />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="phoneNumber" class="form-label">Phone Number</label>
                                    <InputText id="phoneNumber" class="form-control" @bind-Value="editingCustomer!.PhoneNumber" />
                                    <ValidationMessage For="@(() => editingCustomer!.PhoneNumber)" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-12 mb-3">
                                    <label for="address" class="form-label">Address</label>
                                    <InputText id="address" class="form-control" @bind-Value="editingCustomer!.Address" />
                                    <ValidationMessage For="@(() => editingCustomer!.Address)" />
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="city" class="form-label">City</label>
                                    <InputText id="city" class="form-control" @bind-Value="editingCustomer!.City" />
                                    <ValidationMessage For="@(() => editingCustomer!.City)" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="state" class="form-label">State</label>
                                    <InputText id="state" class="form-control" @bind-Value="editingCustomer!.State" />
                                    <ValidationMessage For="@(() => editingCustomer!.State)" />
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label for="country" class="form-label">Country</label>
                                    <InputText id="country" class="form-control" @bind-Value="editingCustomer!.Country" />
                                    <ValidationMessage For="@(() => editingCustomer!.Country)" />
                                </div>
                            </div>

                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @onclick="CancelEdit" disabled="@isProcessing">
                                    <i class="bi bi-x-circle"></i> Cancel
                                </button>
                                <button type="submit" class="btn btn-success" disabled="@isProcessing">
                                    @if (isProcessing)
                                    {
                                        <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                                    }
                                    <i class="bi bi-save"></i> @(editingCustomer?.AccountId > 0 ? "Update" : "Save")
                                </button>
                            </div>
                        </EditForm>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Delete Confirmation Modal -->
    @if (showDeleteModal)
    {
        <div class="modal fade show d-block" tabindex="-1" style="background-color: rgba(0,0,0,0.5);">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title">Confirm Delete</h5>
                        <button type="button" class="btn-close btn-close-white" @onclick="CancelDelete" disabled="@isProcessing"></button>
                    </div>
                    <div class="modal-body">
                        <div class="text-center mb-3">
                            <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                        </div>
                        <p class="text-center mb-0">Are you sure you want to delete this customer?</p>
                        @if (customerToDelete != null)
                        {
                            <div class="mt-3 p-3 bg-light rounded">
                                <p class="mb-1"><strong>Name:</strong> @customerToDelete.FirstName @customerToDelete.LastName</p>
                                <p class="mb-0"><strong>Email:</strong> @customerToDelete.Email</p>
                            </div>
                        }
                        <p class="text-danger text-center mt-3 mb-0"><small>This action cannot be undone.</small></p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" @onclick="CancelDelete" disabled="@isProcessing">
                            <i class="bi bi-x-circle"></i> Cancel
                        </button>
                        <button type="button" class="btn btn-danger" @onclick="ConfirmDelete" disabled="@isProcessing">
                            @if (isProcessing)
                            {
                                <span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>
                            }
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    }

    @if (isLoading)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Loading customers...</p>
        </div>
    }
    else if (customers == null || !customers.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No customers found. Click "Add New Customer" to create one.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table table-hover table-striped">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>City</th>
                        <th>State</th>
                        <th>Country</th>
                        <th>Date Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var customer in customers)
                    {
                        <tr>
                            <td>@customer.AccountId</td>
                            <td>@customer.FirstName</td>
                            <td>@customer.LastName</td>
                            <td>@customer.Email</td>
                            <td>@(customer.PhoneNumber ?? "-")</td>
                            <td>@(customer.City ?? "-")</td>
                            <td>@(customer.State ?? "-")</td>
                            <td>@(customer.Country ?? "-")</td>
                            <td>@customer.DateCreated.ToString("yyyy-MM-dd HH:mm")</td>
                            <td>
                                <button class="btn btn-sm btn-warning me-1" @onclick="() => EditCustomer(customer)" disabled="@isProcessing">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-danger" @onclick="() => DeleteCustomer(customer.AccountId)" disabled="@isProcessing">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <div class="row mt-3">
            <div class="col">
                <p class="text-muted">Total Customers: @customers.Count()</p>
            </div>
        </div>
    }
</div>

@code {
    private List<crm_app.Models.Customer>? customers;
    private crm_app.Models.Customer? editingCustomer;
    private crm_app.Models.Customer? customerToDelete;
    private bool showForm = false;
    private bool showDeleteModal = false;
    private bool isLoading = true;
    private bool isProcessing = false;
    private string? alertMessage;
    private bool alertSuccess = false;
    private string? modalErrorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }

    private async Task LoadCustomers()
    {
        isLoading = true;
        try
        {
            var result = await CustomerService.GetAllCustomersAsync();
            customers = result.ToList();
        }
        catch (Exception ex)
        {
            ShowAlert($"Error loading customers: {ex.Message}", false);
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ShowAddForm()
    {
        editingCustomer = new crm_app.Models.Customer();
        showForm = true;
        alertMessage = null;
        modalErrorMessage = null;
    }

    private void EditCustomer(crm_app.Models.Customer customer)
    {
        editingCustomer = new crm_app.Models.Customer
        {
            AccountId = customer.AccountId,
            FirstName = customer.FirstName,
            LastName = customer.LastName,
            Email = customer.Email,
            PhoneNumber = customer.PhoneNumber,
            Address = customer.Address,
            City = customer.City,
            State = customer.State,
            Country = customer.Country,
            DateCreated = customer.DateCreated
        };
        showForm = true;
        alertMessage = null;
        modalErrorMessage = null;
    }

    private async Task HandleValidSubmit()
    {
        if (editingCustomer == null) return;

        isProcessing = true;
        modalErrorMessage = null;
        try
        {
            if (editingCustomer.AccountId > 0)
            {
                var result = await CustomerService.UpdateCustomerAsync(editingCustomer);
                if (result.Success)
                {
                    ShowAlert(result.Message, true);
                    await LoadCustomers();
                    CancelEdit();
                }
                else
                {
                    modalErrorMessage = result.Message;
                }
            }
            else
            {
                var result = await CustomerService.CreateCustomerAsync(editingCustomer);
                if (result.Success)
                {
                    ShowAlert(result.Message, true);
                    await LoadCustomers();
                    CancelEdit();
                }
                else
                {
                    modalErrorMessage = result.Message;
                }
            }
        }
        catch (Exception ex)
        {
            modalErrorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void DeleteCustomer(int accountId)
    {
        customerToDelete = customers?.FirstOrDefault(c => c.AccountId == accountId);
        if (customerToDelete != null)
        {
            showDeleteModal = true;
            alertMessage = null;
        }
    }

    private async Task ConfirmDelete()
    {
        if (customerToDelete == null) return;

        isProcessing = true;
        try
        {
            var result = await CustomerService.DeleteCustomerAsync(customerToDelete.AccountId);
            if (result.Success)
            {
                ShowAlert(result.Message, true);
                await LoadCustomers();
                CancelDelete();
            }
            else
            {
                ShowAlert(result.Message, false);
            }
        }
        catch (Exception ex)
        {
            ShowAlert($"Error deleting customer: {ex.Message}", false);
        }
        finally
        {
            isProcessing = false;
        }
    }

    private void CancelDelete()
    {
        customerToDelete = null;
        showDeleteModal = false;
    }

    private void CancelEdit()
    {
        editingCustomer = null;
        showForm = false;
        modalErrorMessage = null;
    }

    private void ShowAlert(string message, bool success)
    {
        alertMessage = message;
        alertSuccess = success;
    }
}
